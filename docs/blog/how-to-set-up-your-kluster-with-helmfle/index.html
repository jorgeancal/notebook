<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Jorge Andreu Calatayud">
<meta name="description" content="We&#39;ll config helmfile. This is not the perfect solution, but this is my way, and it works for me." />
<meta name="keywords" content=", cluster, Kluster, helm, helmcharts, kubernetes, helmfile" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://jorgesnotebook.com/blog/how-to-set-up-your-kluster-with-helmfle/" />


    <title>
        
            How to set up your kluster with helmfile :: Jorge&#39;s notebook 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.3d89495748aff88bbfbb2a665d8e1260b3aa63445cd77cc810fb6477aba343dd.css">




    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="How to set up your kluster with helmfile">
<meta itemprop="description" content="We&#39;ll config helmfile. This is not the perfect solution, but this is my way, and it works for me."><meta itemprop="datePublished" content="2021-01-30T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-01-30T00:00:00+00:00" />
<meta itemprop="wordCount" content="989">
<meta itemprop="keywords" content="cluster,Kluster,helm,helmcharts,kubernetes,helmfile," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to set up your kluster with helmfile"/>
<meta name="twitter:description" content="We&#39;ll config helmfile. This is not the perfect solution, but this is my way, and it works for me."/>
<meta name="twitter:site" content="@@jorgeancal"/>





    <meta property="article:section" content="Helm" />

    <meta property="article:section" content="kubernetes" />

    <meta property="article:section" content="How to" />

    <meta property="article:section" content="cluster" />



    <meta property="article:published_time" content="2021-01-30 00:00:00 &#43;0000 UTC" />









    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-108421112-2', 'auto');
	
	ga('send', 'pageview');
}
</script>

    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">hello</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner">
            
            <div class="submenu">
                <li class="dropdown">
                    <a href="/">
                        Home
                    </a>
                </li>
            </div>
            
        
            
            <div class="submenu">
                <li class="dropdown">
                    <a href="/about/">
                        About
                    </a>
                </li>
            </div>
            
        
            
            <div class="submenu">
                <li class="dropdown">
                    <a href="/blog/">
                        Blog
                    </a>
                </li>
            </div>
            
        
            
            <div class="submenu">
                <li class="dropdown">
                    <a href="/categories/">
                        Categories
                    </a>
                </li>
            </div>
            
        

    
    
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
              
                
                Also available in
                    <a href="https://jorgesnotebook.com/es/blog/how-to-set-up-your-kluster-with-helmfle/"><span class="flag flag-icon flag-icon-es flag-icon-squared"></span></a>
                
              
            
            </p>
        </div>

        <article>
            
                <h2 class="post-title"><a href="https://jorgesnotebook.com/blog/how-to-set-up-your-kluster-with-helmfle/">How to set up your kluster with helmfile</a></h2>
            


            
            
            

            <div class="post-content">
                <p>Helmfile is a tool that allows you to get more out of Helm. When you use helmfile, you can implement as many charts as you want. Helmfile allows you to template the charts with the values that you want, and it will ship it to your cluster. Helmfile brings modular deployments too, by this I mean that you can have a huge list of deployments, and you can say deploy only this group of helmchart, you can also deploy them in sequence.</p>
<h2 id="what-do-i-like-about-helmfile">What do I like about helmfile?</h2>
<p>After six months using helmfile, this is what I liked the most about helmfile:</p>
<ul>
<li>
<p>It&rsquo;s stupidly faster because you have all the releases in the same file, and you ship them to the cluster in the order that you want.</p>
</li>
<li>
<p>Centralized Values. I love the possibility of having a main config per environment and then be able to apply those different values to the charts.</p>
</li>
<li>
<p><code>diff</code>. This command in helmfile lets me compare with the current chart that I have in the cluster. I know that when you exec the diff you have thousands of lines, but sometimes it&rsquo;s useful because it shows what you changed, or if you just blew it up.</p>
</li>
<li>
<p>Env Variables. This is a lovely alternative to get everything working without having passwords in plain text in a file. An alternative to this is <code>helm-secrets</code>, but I didn&rsquo;t use it, so I cannot tell you how good it is. I have to say that it is an awesome idea that you can use <code>sops</code> to encode the variables value. I&rsquo;m starting to look into it, but I haven&rsquo;t implemented it yet.</p>
</li>
</ul>
<h2 id="how-to-set-up-helmfile">How to set up Helmfile?</h2>
<p>Firstly, we need to set up a folder schema. You can have it in a folder with other stuff, but I prefer to have it in the root of the repo. It&rsquo;s going to be better if I show you the schema.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── addReleases.sh
</span></span><span style="display:flex;"><span>├── base
</span></span><span style="display:flex;"><span>│   ├── defaults
</span></span><span style="display:flex;"><span>│   │   └── helmfile.yaml
</span></span><span style="display:flex;"><span>|   ├── environments
</span></span><span style="display:flex;"><span>│   │   └── helmfile.yaml
</span></span><span style="display:flex;"><span>│   ├── repositories
</span></span><span style="display:flex;"><span>│   │   └── helmfile.yaml
</span></span><span style="display:flex;"><span>│   ├── templates
</span></span><span style="display:flex;"><span>│   │   └── template.yaml
</span></span><span style="display:flex;"><span>│   └── values
</span></span><span style="display:flex;"><span>│       ├── minikube
</span></span><span style="display:flex;"><span>│       │   └── values.yaml.gotmpl
</span></span><span style="display:flex;"><span>│       └── production
</span></span><span style="display:flex;"><span>│           └── values.yaml.gotmpl
</span></span><span style="display:flex;"><span>├── helmfile.yaml
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>└── releases
</span></span><span style="display:flex;"><span>    ├── prometheus
</span></span><span style="display:flex;"><span>    │   ├── helmfile.yaml
</span></span><span style="display:flex;"><span>    │   ├── README.md
</span></span><span style="display:flex;"><span>    │   └── values.yaml.gotmpl
</span></span><span style="display:flex;"><span>    └── grafana
</span></span><span style="display:flex;"><span>        ├── helmfile.yaml
</span></span><span style="display:flex;"><span>        ├── README.md
</span></span><span style="display:flex;"><span>        └── values.yaml.gotmpl
</span></span></code></pre></div><p>Now I&rsquo;m going to show you what I have in the main helmfile file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{ <span style="color:#ae81ff">readFile &#34;base/templates/helmfile.yaml&#34; }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">readFile &#34;base/repositories/helmfile.yaml&#34; }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">releases</span>:
</span></span></code></pre></div><p>As you can see above, we have two readFile commands and a release field with no releases. Let&rsquo;s go to follow the file line by line. The first line is going to be the template that I&rsquo;ve created with some patterns that will be the same for all the releases, and I don&rsquo;t want to write the same line ten times&hellip; After that, we have the readfile for the repositories. Yep, we have all the repositories from all the files in there&hellip; yeah, it sounds crazy, but it gives you a bit more speed.</p>
<p>Now let&rsquo;s see the template file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">bases</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">base/defaults/helmfile.yaml</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">base/environments/helmfile.yaml</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">templates</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">defaultTmpl</span>: <span style="color:#75715e">&amp;defaultTmpl</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">missingFileHandler</span>: <span style="color:#ae81ff">Warn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">valuesTemplate</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">base/values/{{ .Environment.Name }}/values.yaml.gotmpl</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">releases/{{ .Release.Name }}/values.yaml.gotmpl</span>
</span></span></code></pre></div><p>As you can see, we have a bit more than a simple template here. We have the bases in here too. I have two bases. The first base is the default config, you can see all the options in their <a href="https://github.com/roboll/helmfile/blob/master/README.md#configuration">readme</a>. The second base is the environments where I declare values for them. These variables are going to allow me to declare which releases I want to release into the cluster. I have to say that I would probably move them to the main hemlfile or change the name of the file at some point. I like the bases in the file at the moment because it kind of feels like the template is part of the base of helmfile.</p>
<p>It&rsquo;s time to see how I release everything&hellip; In the next file, you&rsquo;ll see an example of my grafana release. In the first line, we&rsquo;ll have the template that we are implementing. After that, we would have the name, chart, namespace and version as we have on any kind of release in Helm. After all these fields, we have the one that allows me to tell it if I want it to be installed or not. After that one, I have the dependencies of that chart. That means that helmfile is not going to release it until the others have been released.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">&lt;&lt;</span>: <span style="color:#75715e">*defaultTmpl</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>:  <span style="color:#e6db74">&#34;grafana&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">chart</span>: <span style="color:#e6db74">&#34;grafana/grafana&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#e6db74">&#34;monitoring&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.2.5&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">installed</span>: {{ <span style="color:#ae81ff">.Values | getOrNil &#34;grafana.installed&#34; | default false }}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">needs</span>: 
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">observability/fluentd</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">observability/prometheus</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">operators/jaeger-operator</span>
</span></span></code></pre></div><h2 id="how-to-use-it">How to use it</h2>
<p>This is the simplest thing that you&rsquo;re going to see in this post&hellip; you need to go to your main helmfile and run the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>helmfile -e minikube apply 
</span></span></code></pre></div><p>Before you run that command, you are going to need to run a bash script. This bash script is going to template the small helmfile releases to the main helmfile.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> release in <span style="color:#e6db74">`</span>find releases/ -name <span style="color:#e6db74">&#34;*.yaml&#34;</span><span style="color:#e6db74">`</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    release_name<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>cat $release | grep <span style="color:#e6db74">&#34;name: &#34;</span> | cut -d<span style="color:#e6db74">&#39; &#39;</span> -f2-<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Templating  </span>$release<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    cat $release | sed <span style="color:#e6db74">&#39;s/\(.*\)/  \1/&#39;</span> &gt;&gt; helmfile.yaml
</span></span><span style="display:flex;"><span>    echo &gt;&gt; helmfile.yaml
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>After running this script, your helmfile.yaml should look something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">readFile &#34;base/templates/helmfile.yaml&#34; }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">readFile &#34;base/repositories/helmfile.yaml&#34; }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">releases</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">&lt;&lt;</span>: <span style="color:#75715e">*defaultTmpl</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>:  <span style="color:#e6db74">&#34;grafana&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">chart</span>: <span style="color:#e6db74">&#34;grafana/grafana&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#e6db74">&#34;monitoring&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.2.5&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">installed</span>: {{ <span style="color:#ae81ff">.Values | getOrNil &#34;grafana.installed&#34; | default false }}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">needs</span>: 
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">observability/fluentd</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">observability/prometheus</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">operators/jaeger-operator</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">operators/istio-operator</span>
</span></span></code></pre></div><p>I have to say that this is not the perfect way to use helmfile, but this is how I use it, and it works for me. You can see all the files in this <a href="https://github.com/jorgeancal/helmfile-schema">repo</a>. Thanks for reading me, everyone! I hope you like this post, and I&rsquo;ll see you in the next one.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://jorgesnotebook.com/tags/cluster/">cluster</a></span>
        <span class="tag"><a href="https://jorgesnotebook.com/tags/kluster/">Kluster</a></span>
        <span class="tag"><a href="https://jorgesnotebook.com/tags/helm/">helm</a></span>
        <span class="tag"><a href="https://jorgesnotebook.com/tags/helmcharts/">helmcharts</a></span>
        <span class="tag"><a href="https://jorgesnotebook.com/tags/kubernetes/">kubernetes</a></span>
        <span class="tag"><a href="https://jorgesnotebook.com/tags/helmfile/">helmfile</a></span>
        
    </p>

            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>

        <span class="tag"><a href="https://jorgesnotebook.com/categories/helm/">Helm</a></span>
        <span class="tag"><a href="https://jorgesnotebook.com/categories/kubernetes/">kubernetes</a></span>
        <span class="tag"><a href="https://jorgesnotebook.com/categories/how-to/">How to</a></span>
        <span class="tag"><a href="https://jorgesnotebook.com/categories/cluster/">cluster</a></span>
        
    </p>

  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
    
        <div class="footer__inner">
          
        </div>
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.6287a2177681a8a9b1c767e7f6a078bf494acb05a113fe2c5c5833c6f9cf368099768ffab3b5a424a8636a3aa24de5cb7d30e53fa421ccad9f5431e5c09a3ee3.js" integrity="sha512-YoeiF3aBqKmxx2fn9qB4v0lKywWhE/4sXFgzxvnPNoCZdo/6s7WkJKhjajqiTeXLfTDlP6QhzK2fVDHlwJo&#43;4w=="></script>



    </body>
</html>
