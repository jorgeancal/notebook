<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="We&#39;ll config helmfile. This is not the perfect solution, but this is my way, and it works for me.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="How to set up your kluster with helmfile" />
<meta property="og:description" content="We&#39;ll config helmfile. This is not the perfect solution, but this is my way, and it works for me." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jorgesnotebook.com/posts/how-to-set-up-your-kluster-with-helmfle/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-08-15T19:16:26+01:00" />
<title>How to set up your kluster with helmfile | Jorge&#39;s notebook</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" >
  <link rel="alternate" hreflang="es" href="https://jorgesnotebook.com/es/posts/how-to-set-up-your-kluster-with-helmfle/" title="Configurar tu kluster con Helmfile">
<link rel="stylesheet" href="/book.min.f8de3645fe00591b41524aee174e19edd98a22255a2930a0cdc82a94835ba387.css" integrity="sha256-&#43;N42Rf4AWRtBUkruF04Z7dmKIiVaKTCgzcgqlINbo4c=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.56a170ceda453cffb5e0fe652224d6368616d0c504c7189fea9f66ccc326a89c.js" integrity="sha256-VqFwztpFPP&#43;14P5lIiTWNoYW0MUExxif6p9mzMMmqJw=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-108421112-2', 'auto');
	
	ga('send', 'pageview');
}
</script><!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/favicon.png" alt="Logo" /><span>Jorge&#39;s notebook</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>



  



  
    
  


  


<ul class="book-languages">
  <li>
    <input type="checkbox" id="languages" class="toggle" />
    <label for="languages" class="flex justify-between">
      <a role="button" class="flex align-center">
        <img src="/svg/translate.svg" class="book-icon" alt="Languages" />
        English
      </a>
    </label>

    <ul>
      
      <li>
        <a href="https://jorgesnotebook.com/es/posts/how-to-set-up-your-kluster-with-helmfle/">
          Castellano
        </a>
      </li>
      
    </ul>
  </li>
</ul>











  

  



  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a07783f405300745807d39eacf150420" class="toggle" checked />
    <label for="section-a07783f405300745807d39eacf150420" class="flex justify-between">
      <a role="button" class="">Posts</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/posts/how-to-create-a-k8s-homelab/" class="">Create your own cluster</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/how-to-implement-sops-helmfile/" class="">How to config SOPS in Helm</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/how-to-set-up-your-kluster-with-helmfle/" class="active">How to set up your kluster with helmfile</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/how-to-create-a-small-jvm-docker-image/" class="">jlink with Spring Boot services</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/starting-with-spring-boot/" class="">Starting with Spring Boot</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/what-is-going-on-with-java/" class="">What’s going on with Java?</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/how-to-install-gitlab-on-debian-9/" class="">How to Install Gitlab on Debian 9</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/how-to-install-jenkins/" class="">How to Install Jenkins</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/about/" class="">About</a>
  

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="https://github.com/jorgeancal/"  target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>How to set up your kluster with helmfile</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#what-do-i-like-about-helmfile">What do I like about helmfile?</a></li>
        <li><a href="#how-to-set-up-helmfile">How to set up Helmfile?</a></li>
        <li><a href="#how-to-use-it">How to use it</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><p>Helmfile is a tool that allows you to get more out of Helm. When you use helmfile, you can implement as many charts as you want. Helmfile allows you to template the charts with the values that you want, and it will ship it to your cluster. Helmfile brings modular deployments too, by this I mean that you can have a huge list of deployments, and you can say deploy only this group of helmchart, you can also deploy them in sequence.</p>
<h2 id="what-do-i-like-about-helmfile">
  What do I like about helmfile?
  <a class="anchor" href="#what-do-i-like-about-helmfile">#</a>
</h2>
<p>After six months using helmfile, this is what I liked the most about helmfile:</p>
<ul>
<li>
<p>It&rsquo;s stupidly faster because you have all the releases in the same file, and you ship them to the cluster in the order that you want.</p>
</li>
<li>
<p>Centralized Values. I love the possibility of having a main config per environment and then be able to apply those different values to the charts.</p>
</li>
<li>
<p><code>diff</code>. This command in helmfile lets me compare with the current chart that I have in the cluster. I know that when you exec the diff you have thousands of lines, but sometimes it&rsquo;s useful because it shows what you changed, or if you just blew it up.</p>
</li>
<li>
<p>Env Variables. This is a lovely alternative to get everything working without having passwords in plain text in a file. An alternative to this is <code>helm-secrets</code>, but I didn&rsquo;t use it, so I cannot tell you how good it is. I have to say that it is an awesome idea that you can use <code>sops</code> to encode the variables value. I&rsquo;m starting to look into it, but I haven&rsquo;t implemented it yet.</p>
</li>
</ul>
<h2 id="how-to-set-up-helmfile">
  How to set up Helmfile?
  <a class="anchor" href="#how-to-set-up-helmfile">#</a>
</h2>
<p>Firstly, we need to set up a folder schema. You can have it in a folder with other stuff, but I prefer to have it in the root of the repo. It&rsquo;s going to be better if I show you the schema.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── addReleases.sh
</span></span><span style="display:flex;"><span>├── base
</span></span><span style="display:flex;"><span>│   ├── defaults
</span></span><span style="display:flex;"><span>│   │   └── helmfile.yaml
</span></span><span style="display:flex;"><span>|   ├── environments
</span></span><span style="display:flex;"><span>│   │   └── helmfile.yaml
</span></span><span style="display:flex;"><span>│   ├── repositories
</span></span><span style="display:flex;"><span>│   │   └── helmfile.yaml
</span></span><span style="display:flex;"><span>│   ├── templates
</span></span><span style="display:flex;"><span>│   │   └── template.yaml
</span></span><span style="display:flex;"><span>│   └── values
</span></span><span style="display:flex;"><span>│       ├── minikube
</span></span><span style="display:flex;"><span>│       │   └── values.yaml.gotmpl
</span></span><span style="display:flex;"><span>│       └── production
</span></span><span style="display:flex;"><span>│           └── values.yaml.gotmpl
</span></span><span style="display:flex;"><span>├── helmfile.yaml
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>└── releases
</span></span><span style="display:flex;"><span>    ├── prometheus
</span></span><span style="display:flex;"><span>    │   ├── helmfile.yaml
</span></span><span style="display:flex;"><span>    │   ├── README.md
</span></span><span style="display:flex;"><span>    │   └── values.yaml.gotmpl
</span></span><span style="display:flex;"><span>    └── grafana
</span></span><span style="display:flex;"><span>        ├── helmfile.yaml
</span></span><span style="display:flex;"><span>        ├── README.md
</span></span><span style="display:flex;"><span>        └── values.yaml.gotmpl
</span></span></code></pre></div><p>Now I&rsquo;m going to show you what I have in the main helmfile file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{ <span style="color:#ae81ff">readFile &#34;base/templates/helmfile.yaml&#34; }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">readFile &#34;base/repositories/helmfile.yaml&#34; }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">releases</span>:
</span></span></code></pre></div><p>As you can see above, we have two readFile commands and a release field with no releases. Let&rsquo;s go to follow the file line by line. The first line is going to be the template that I&rsquo;ve created with some patterns that will be the same for all the releases, and I don&rsquo;t want to write the same line ten times&hellip; After that, we have the readfile for the repositories. Yep, we have all the repositories from all the files in there&hellip; yeah, it sounds crazy, but it gives you a bit more speed.</p>
<p>Now let&rsquo;s see the template file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">bases</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">base/defaults/helmfile.yaml</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">base/environments/helmfile.yaml</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">templates</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">defaultTmpl</span>: <span style="color:#75715e">&amp;defaultTmpl</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">missingFileHandler</span>: <span style="color:#ae81ff">Warn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">valuesTemplate</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">base/values/{{ .Environment.Name }}/values.yaml.gotmpl</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">releases/{{ .Release.Name }}/values.yaml.gotmpl</span>
</span></span></code></pre></div><p>As you can see, we have a bit more than a simple template here. We have the bases in here too. I have two bases. The first base is the default config, you can see all the options in their 
  <a href="https://github.com/roboll/helmfile/blob/master/README.md#configuration">readme</a>. The second base is the environments where I declare values for them. These variables are going to allow me to declare which releases I want to release into the cluster. I have to say that I would probably move them to the main hemlfile or change the name of the file at some point. I like the bases in the file at the moment because it kind of feels like the template is part of the base of helmfile.</p>
<p>It&rsquo;s time to see how I release everything&hellip; In the next file, you&rsquo;ll see an example of my grafana release. In the first line, we&rsquo;ll have the template that we are implementing. After that, we would have the name, chart, namespace and version as we have on any kind of release in Helm. After all these fields, we have the one that allows me to tell it if I want it to be installed or not. After that one, I have the dependencies of that chart. That means that helmfile is not going to release it until the others have been released.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">&lt;&lt;</span>: <span style="color:#75715e">*defaultTmpl</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>:  <span style="color:#e6db74">&#34;grafana&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">chart</span>: <span style="color:#e6db74">&#34;grafana/grafana&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#e6db74">&#34;monitoring&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.2.5&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">installed</span>: {{ <span style="color:#ae81ff">.Values | getOrNil &#34;grafana.installed&#34; | default false }}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">needs</span>: 
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">observability/fluentd</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">observability/prometheus</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">operators/jaeger-operator</span>
</span></span></code></pre></div><h2 id="how-to-use-it">
  How to use it
  <a class="anchor" href="#how-to-use-it">#</a>
</h2>
<p>This is the simplest thing that you&rsquo;re going to see in this post&hellip; you need to go to your main helmfile and run the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>helmfile -e minikube apply 
</span></span></code></pre></div><p>Before you run that command, you are going to need to run a bash script. This bash script is going to template the small helmfile releases to the main helmfile.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> release in <span style="color:#e6db74">`</span>find releases/ -name <span style="color:#e6db74">&#34;*.yaml&#34;</span><span style="color:#e6db74">`</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    release_name<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>cat $release | grep <span style="color:#e6db74">&#34;name: &#34;</span> | cut -d<span style="color:#e6db74">&#39; &#39;</span> -f2-<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Templating  </span>$release<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    cat $release | sed <span style="color:#e6db74">&#39;s/\(.*\)/  \1/&#39;</span> &gt;&gt; helmfile.yaml
</span></span><span style="display:flex;"><span>    echo &gt;&gt; helmfile.yaml
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>After running this script, your helmfile.yaml should look something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">readFile &#34;base/templates/helmfile.yaml&#34; }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{ <span style="color:#ae81ff">readFile &#34;base/repositories/helmfile.yaml&#34; }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">releases</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">&lt;&lt;</span>: <span style="color:#75715e">*defaultTmpl</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>:  <span style="color:#e6db74">&#34;grafana&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">chart</span>: <span style="color:#e6db74">&#34;grafana/grafana&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#e6db74">&#34;monitoring&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.2.5&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">installed</span>: {{ <span style="color:#ae81ff">.Values | getOrNil &#34;grafana.installed&#34; | default false }}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">needs</span>: 
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">observability/fluentd</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">observability/prometheus</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">operators/jaeger-operator</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">operators/istio-operator</span>
</span></span></code></pre></div><p>I have to say that this is not the perfect way to use helmfile, but this is how I use it, and it works for me. You can see all the files in this 
  <a href="https://github.com/jorgeancal/helmfile-schema">repo</a>. Thanks for reading me, everyone! I hope you like this post, and I&rsquo;ll see you in the next one.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/jorgeancal/notebook/commit/e9227fb78021a12bef0904ce11e20dc9d2c92c35" title='Last modified by Jorge Andreu | August 15, 2023' target="_blank" rel="noopener">
      <img src="/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>August 15, 2023</span>
    </a>
  </div>




</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">
<div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jorgesnotebook" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#what-do-i-like-about-helmfile">What do I like about helmfile?</a></li>
        <li><a href="#how-to-set-up-helmfile">How to set up Helmfile?</a></li>
        <li><a href="#how-to-use-it">How to use it</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












